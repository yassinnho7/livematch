name: Site Health Monitor

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

permissions:
  actions: write
  contents: write

concurrency:
  group: site-health-monitor
  cancel-in-progress: true

jobs:
  monitor:
    runs-on: ubuntu-latest
    outputs:
      site_down: ${{ steps.probe.outputs.site_down }}
    steps:
      - name: Probe pages.dev endpoints
        id: probe
        run: |
          set -euo pipefail

          site_down="false"
          for attempt in 1 2 3; do
            echo "Probe attempt $attempt/3"

            home="$(curl -sS --http1.1 --connect-timeout 8 --max-time 20 "https://livematch-991.pages.dev/" || true)"
            matches="$(curl -sS --http1.1 --connect-timeout 8 --max-time 20 "https://livematch-991.pages.dev/data/matches.json" || true)"
            health="$(curl -sS --http1.1 --connect-timeout 8 --max-time 20 "https://livematch-991.pages.dev/healthz.txt" || true)"

            ok_home="false"
            ok_matches="false"
            ok_health="false"

            if printf "%s" "$home" | grep -qiE "<title|<!doctype html>"; then
              ok_home="true"
            fi
            if printf "%s" "$matches" | grep -q "\"matches\""; then
              ok_matches="true"
            fi
            if [ "$(printf "%s" "$health" | tr -d '\r\n ')" = "ok" ]; then
              ok_health="true"
            fi

            echo "home=$ok_home matches=$ok_matches health=$ok_health"
            if [ "$ok_home" = "true" ] && [ "$ok_matches" = "true" ] && [ "$ok_health" = "true" ]; then
              echo "Site probe healthy"
              echo "site_down=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            sleep 10
          done

          site_down="true"

          echo "site_down=$site_down" >> "$GITHUB_OUTPUT"
          echo "Site probe failed"

  auto-recover:
    runs-on: ubuntu-latest
    needs: monitor
    if: needs.monitor.outputs.site_down == 'true'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Force Pages redeploy with heartbeat commit
        run: |
          set -euo pipefail
          mkdir -p public
          date -u +"%Y-%m-%dT%H:%M:%SZ" > public/redeploy-heartbeat.txt

          git config --global user.name "Health Monitor Bot"
          git config --global user.email "actions@github.com"
          git add public/redeploy-heartbeat.txt

          if ! git diff --cached --quiet; then
            git commit -m "Auto-recover: force Pages redeploy ($(date -u '+%H:%M UTC'))"
            git push origin HEAD:main
          fi

      - name: Trigger hourly scrape workflow for recovery
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          curl -sS -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/hourly-scrape.yml/dispatches \
            -d '{"ref":"main"}'
          echo "Triggered hourly-scrape.yml workflow_dispatch"

      - name: Mark run as failed for visibility
        run: |
          echo "Site is down. Auto-recovery was triggered."
          exit 1
