name: LiveKora Scraping Every 7 Mins

on:
  schedule:
    - cron: '*/7 * * * *'  # Runs every 7 minutes
  workflow_dispatch:

permissions:
  contents: write

jobs:
  scrape-and-update:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Puppeteer Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgbm-dev libasound2 libnss3 libatk1.0-0 libatk-bridge2.0-0 libcups2 libdrm2 libxkbcommon0 libxcomposite1 libxdamage1 libxrandr2 libpangocairo-1.0-0 libpango-1.0-0
          
      - name: Install Node Dependencies
        run: |
          npm install puppeteer puppeteer-extra puppeteer-extra-plugin-stealth
      
      - name: Run LiveKora Scraper
        run: |
          node scrapers/livekora_scraper.js
      
      - name: Notify Webhook (Make.com)
        env:
          MAKE_WEBHOOK_URL: ${{ secrets.MAKE_WEBHOOK_URL }}
        run: |
          node scrapers/notify_webhook.js
      
      - name: Notify Telegram (Direct)
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          node scrapers/notify_telegram.js
      
      - name: Commit and Push Changes
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          # Add critical files first (must succeed)
          git add public/data/matches.json
          
          # Add optional log files (ignore if missing)
          git add sent_notifications.json || true
          git add sent_telegram_notifications.json || true
          
          git diff --cached --quiet || git commit -m "ðŸ”„ Auto-update: LiveKora matches data [$(date +'%Y-%m-%d %H:%M UTC')]"
          
          # Retry loop for push to handle race conditions
          n=0
          until [ "$n" -ge 10 ]
          do
             echo "Push attempt $((n+1))..."
             git pull --rebase origin main || git rebase --abort
             git push origin main && break
             n=$((n+1)) 
             sleep 10
          done
