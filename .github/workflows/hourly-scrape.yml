name: LiveKora Scraping Every 7 Mins

on:
  schedule:
    - cron: '*/7 * * * *'  # Runs every 7 minutes
  workflow_dispatch:

permissions:
  contents: write

jobs:
  scrape-and-update:
    runs-on: ubuntu-22.04
    timeout-minutes: 12
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache Puppeteer Browser
        uses: actions/cache@v4
        with:
          path: ~/.cache/puppeteer
          key: ${{ runner.os }}-puppeteer-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-puppeteer-
      
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends libgbm-dev libasound2 libnss3 libatk1.0-0 libatk-bridge2.0-0 libcups2 libdrm2 libxkbcommon0 libxcomposite1 libxdamage1 libxrandr2 libpangocairo-1.0-0 libpango1.0-0 build-essential libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev wget gnupg

      - name: Install Chrome Browser
        run: |
          npx puppeteer browsers install chrome

      - name: Install Node Dependencies
        env:
          PUPPETEER_CACHE_DIR: ${{ github.workspace }}/.cache/puppeteer
          PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: 'false'
        run: |
          npm install --no-audit --no-fund
      
      - name: Download Arabic Font (Cairo)
        run: |
          mkdir -p public/assets/fonts
          wget -O public/assets/fonts/Cairo-Bold.ttf https://github.com/Gue3bara/Cairo/raw/v3.116/fonts/ttf/Cairo-Bold.ttf
      
      - name: "Run Scraper Manager (Multi-Source: LiveKora + Korah.live + Siiir.tv)"
        env:
          GEMINI_API_KEYS: ${{ secrets.GEMINI_API_KEYS }}
        run: |
          node scrapers/scraper_manager.js
      
      # - name: Generate Match Posters (AI-Hybrid)
      #   run: |
      #     node scripts/generate_posters.js
      
      - name: Notify Webhook (Make.com)
        env:
          MAKE_WEBHOOK_URL: ${{ secrets.MAKE_WEBHOOK_URL }}
        run: |
          node scrapers/notify_webhook.js
      
      - name: Notify Telegram (Direct)
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          node scrapers/notify_telegram.js
      
      - name: Commit and Push Changes
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          # Add critical files first (must succeed)
          git add public/data/matches.json
          
          # Add/Remove generated posters
          git add --all public/posters 2>/dev/null || true
          
          # Add/Remove AI-generated articles
          git add --all public/data/articles 2>/dev/null || true
          
          # Add optional log files (ignore if missing)
          git add sent_notifications.json 2>/dev/null || true
          git add sent_telegram_notifications.json 2>/dev/null || true
          git add telegram_prekick_state.json 2>/dev/null || true
          git add telegram_bot_state.json 2>/dev/null || true
          
          # If no changes, exit cleanly
          if git diff --cached --quiet; then
            echo "‚úÖ No changes to commit ‚Äî skipping push"
            exit 0
          fi
          
          git commit -m "üîÑ Auto-update: LiveKora matches data ($(date '+%H:%M'))"
          
          # Push with Retry ‚Äî doesn't cancel changes
          MAX=5
          for n in $(seq 1 $MAX); do
            echo "üì§ Push attempt $n/$MAX..."
            # First, discard any local changes that might conflict
            git checkout -- .
            # Then try to pull and push
            git pull origin main --no-rebase --quiet 2>/dev/null || true
            git push origin main && break
            
            if [ $n -eq $MAX ]; then
              echo "‚ùå All push attempts failed"
              exit 1
            fi
            echo "‚è≥ Waiting 20s before retry..."
            sleep 20
          done
