name: LiveKora Scraping Every 15 Mins

on:
  schedule:
    - cron: '*/15 * * * *'  # Runs every 15 minutes
  workflow_dispatch:

permissions:
  contents: write

jobs:
  scrape-and-update:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Dependencies
        run: |
          npm install puppeteer puppeteer-extra puppeteer-extra-plugin-stealth
      
      - name: Run LiveKora Scraper
        run: |
          node scrapers/livekora_scraper.js
      
      - name: Notify Webhook (Make.com)
        env:
          MAKE_WEBHOOK_URL: ${{ secrets.MAKE_WEBHOOK_URL }}
        run: |
          node scrapers/notify_webhook.js
      
      - name: Notify Telegram (Direct)
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          node scrapers/notify_telegram.js
      
      - name: Commit and Push Changes
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          # Add critical files first (must succeed)
          git add public/data/matches.json
          
          # Add optional log files (ignore if missing)
          git add sent_notifications.json || true
          git add sent_telegram_notifications.json || true
          
          git diff --cached --quiet || git commit -m "ðŸ”„ Auto-update: LiveKora matches data [$(date +'%Y-%m-%d %H:%M UTC')]"
          git push || echo "No changes to push"
